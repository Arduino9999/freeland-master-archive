<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freeland Command Center - Live Terminal</title>
    <style>
        :root {
            --bg: #0a0a0f;
            --bg-card: #12121a;
            --bg-terminal: #0d1117;
            --border: #2a2a3a;
            --text: #e0e0e0;
            --text-dim: #6e7681;
            --accent: #f7931e;
            --green: #4ade80;
            --red: #ef4444;
            --blue: #3b82f6;
            --purple: #a855f7;
            --cyan: #22d3ee;
            --yellow: #fbbf24;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .app {
            display: grid;
            grid-template-columns: 400px 1fr;
            grid-template-rows: auto 1fr;
            height: 100vh;
        }

        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #1a1a25, #0a0a0f);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent), #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--red);
        }

        .status-dot.connected {
            background: var(--green);
            box-shadow: 0 0 10px var(--green);
        }

        .sidebar {
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            font-size: 1rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filter-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
            margin: 0.5rem 1rem;
            width: calc(100% - 2rem);
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .project-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .project-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-item:hover {
            border-color: var(--accent);
        }

        .project-item.running {
            border-color: var(--green);
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.1);
        }

        .project-item.selected {
            border-color: var(--accent);
            background: rgba(247, 147, 30, 0.1);
        }

        .project-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .project-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .project-status {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .project-status.running {
            background: rgba(74, 222, 128, 0.2);
            color: var(--green);
        }

        .project-status.stopped {
            background: rgba(110, 118, 129, 0.2);
            color: var(--text-dim);
        }

        .project-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .tag {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-dim);
        }

        .tag.worker { color: #ff6b35; }
        .tag.react { color: #61dafb; }
        .tag.vite { color: #646cff; }

        .main-content {
            display: flex;
            flex-direction: column;
            background: var(--bg);
        }

        .terminal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
        }

        .terminal-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .terminal-title h3 {
            font-size: 1rem;
        }

        .terminal-title .path {
            font-family: 'Consolas', monospace;
            font-size: 0.8rem;
            color: var(--cyan);
        }

        .terminal-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 500;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-run {
            background: var(--green);
            color: #000;
        }

        .btn-run:hover:not(:disabled) {
            background: #22c55e;
        }

        .btn-stop {
            background: var(--red);
            color: #fff;
        }

        .btn-stop:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-deploy {
            background: var(--blue);
            color: #fff;
        }

        .btn-deploy:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            border-color: var(--accent);
        }

        .terminal {
            flex: 1;
            background: var(--bg-terminal);
            font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            padding: 1rem;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .terminal-line {
            margin: 0;
        }

        .terminal-line.stdout {
            color: var(--text);
        }

        .terminal-line.stderr {
            color: var(--red);
        }

        .terminal-line.info {
            color: var(--cyan);
        }

        .terminal-line.success {
            color: var(--green);
        }

        .terminal-line.warning {
            color: var(--yellow);
        }

        .terminal-line.error {
            color: var(--red);
            font-weight: bold;
        }

        .terminal-line.system {
            color: var(--purple);
            font-style: italic;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-dim);
            text-align: center;
            padding: 2rem;
        }

        .welcome-screen h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-screen p {
            max-width: 400px;
            line-height: 1.8;
        }

        .running-indicator {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--green);
            border-radius: 12px;
            padding: 1rem;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .running-indicator.visible {
            display: block;
        }

        .running-indicator h4 {
            color: var(--green);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .running-list {
            font-size: 0.8rem;
        }

        .running-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.visible {
            display: block;
        }

        .toast.success {
            border-color: var(--green);
        }

        .toast.error {
            border-color: var(--red);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-dim);
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <h1>
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="3" width="20" height="14" rx="2"/>
                    <path d="M8 21h8M12 17v4"/>
                </svg>
                Freeland Command Center
            </h1>
            <div class="connection-status">
                <span class="status-dot" id="connectionDot"></span>
                <span id="connectionText">Connecting...</span>
            </div>
        </header>

        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Projects</h2>
                <span id="projectCount">0</span>
            </div>
            <input type="text" class="filter-input" placeholder="Filter projects..." id="filterInput">
            <div class="project-list" id="projectList"></div>
        </aside>

        <main class="main-content">
            <div id="welcomeScreen" class="welcome-screen">
                <h2>Welcome!</h2>
                <p>Select a project from the sidebar to view its terminal output. Click RUN to start a project, or DEPLOY to push to production.</p>
                <p style="margin-top: 1rem; color: var(--accent);">Built with love by Tom & Azura Freeland</p>
            </div>

            <div id="terminalContainer" style="display: none; flex-direction: column; height: 100%;">
                <div class="terminal-header">
                    <div class="terminal-title">
                        <h3 id="terminalProjectName">Project Name</h3>
                        <span class="path" id="terminalProjectPath">/path/to/project</span>
                    </div>
                    <div class="terminal-actions">
                        <button class="btn btn-run" id="btnRun" onclick="runProject()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <polygon points="5 3 19 12 5 21"/>
                            </svg>
                            Run
                        </button>
                        <button class="btn btn-stop" id="btnStop" onclick="stopProject()" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="6" y="6" width="12" height="12"/>
                            </svg>
                            Stop
                        </button>
                        <button class="btn btn-deploy" id="btnDeploy" onclick="deployProject()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                            </svg>
                            Deploy
                        </button>
                        <button class="btn btn-secondary" onclick="installDeps()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            Install
                        </button>
                        <button class="btn btn-secondary" onclick="openFolder()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/>
                            </svg>
                            Open
                        </button>
                        <button class="btn btn-secondary" onclick="clearTerminal()">Clear</button>
                    </div>
                </div>
                <div class="terminal" id="terminal"></div>
            </div>
        </main>
    </div>

    <div class="running-indicator" id="runningIndicator">
        <h4>Running Processes</h4>
        <div class="running-list" id="runningList"></div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let ws = null;
        let projects = [];
        let selectedProject = null;
        let runningProjects = new Set();
        const terminalOutputs = new Map(); // Store output per project

        // Connect to WebSocket
        function connect() {
            ws = new WebSocket(`ws://${window.location.host}`);

            ws.onopen = () => {
                document.getElementById('connectionDot').classList.add('connected');
                document.getElementById('connectionText').textContent = 'Connected';
                loadProjects();
            };

            ws.onclose = () => {
                document.getElementById('connectionDot').classList.remove('connected');
                document.getElementById('connectionText').textContent = 'Disconnected - Reconnecting...';
                setTimeout(connect, 2000);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function handleMessage(data) {
            const { type, projectPath, message } = data;

            // Store output for project
            if (projectPath) {
                if (!terminalOutputs.has(projectPath)) {
                    terminalOutputs.set(projectPath, []);
                }
            }

            switch (type) {
                case 'start':
                    runningProjects.add(projectPath);
                    appendToTerminal(projectPath, `[STARTING] ${message}`, 'system');
                    updateProjectStatus(projectPath, true);
                    updateButtons();
                    break;

                case 'stdout':
                    appendToTerminal(projectPath, data.data, 'stdout');
                    break;

                case 'stderr':
                    appendToTerminal(projectPath, data.data, 'stderr');
                    break;

                case 'exit':
                    runningProjects.delete(projectPath);
                    const exitClass = data.code === 0 ? 'success' : 'error';
                    appendToTerminal(projectPath, `[EXIT] ${message}`, exitClass);
                    updateProjectStatus(projectPath, false);
                    updateButtons();
                    break;

                case 'stopped':
                    runningProjects.delete(projectPath);
                    appendToTerminal(projectPath, `[STOPPED] ${message}`, 'warning');
                    updateProjectStatus(projectPath, false);
                    updateButtons();
                    break;

                case 'error':
                    appendToTerminal(projectPath, `[ERROR] ${message}`, 'error');
                    showToast(message, 'error');
                    break;

                case 'warning':
                    appendToTerminal(projectPath, `[WARNING] ${message}`, 'warning');
                    break;

                case 'info':
                    appendToTerminal(projectPath, `[INFO] ${message}`, 'info');
                    break;

                case 'success':
                    appendToTerminal(projectPath, `[SUCCESS] ${message}`, 'success');
                    showToast(message, 'success');
                    break;

                case 'status':
                    updateRunningIndicator(data.running);
                    break;
            }
        }

        function appendToTerminal(projectPath, text, className = 'stdout') {
            // Store in buffer
            const outputs = terminalOutputs.get(projectPath) || [];
            outputs.push({ text, className });
            terminalOutputs.set(projectPath, outputs);

            // Only display if this project is selected
            if (selectedProject && selectedProject.path === projectPath) {
                const terminal = document.getElementById('terminal');
                const line = document.createElement('div');
                line.className = `terminal-line ${className}`;
                line.textContent = text;
                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;
            }
        }

        function loadProjects() {
            fetch('/api/projects')
                .then(res => res.json())
                .then(data => {
                    projects = data.projects || [];
                    document.getElementById('projectCount').textContent = projects.length;
                    renderProjectList();
                });
        }

        function renderProjectList(filter = '') {
            const list = document.getElementById('projectList');
            const filtered = projects.filter(p =>
                p.name.toLowerCase().includes(filter.toLowerCase()) ||
                p.types.some(t => t.toLowerCase().includes(filter.toLowerCase()))
            );

            list.innerHTML = filtered.map(project => {
                const isRunning = runningProjects.has(project.path);
                const isSelected = selectedProject && selectedProject.path === project.path;
                return `
                    <div class="project-item ${isRunning ? 'running' : ''} ${isSelected ? 'selected' : ''}"
                         onclick="selectProject('${project.path.replace(/\\/g, '\\\\')}')">
                        <div class="project-item-header">
                            <span class="project-name">${project.name}</span>
                            <span class="project-status ${isRunning ? 'running' : 'stopped'}">
                                ${isRunning ? 'Running' : 'Stopped'}
                            </span>
                        </div>
                        <div class="project-tags">
                            ${project.types.map(t => `<span class="tag ${t}">${t}</span>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectProject(path) {
            selectedProject = projects.find(p => p.path === path);
            if (!selectedProject) return;

            // Update UI
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('terminalContainer').style.display = 'flex';
            document.getElementById('terminalProjectName').textContent = selectedProject.name;
            document.getElementById('terminalProjectPath').textContent = selectedProject.path;

            // Load stored terminal output
            const terminal = document.getElementById('terminal');
            terminal.innerHTML = '';
            const outputs = terminalOutputs.get(path) || [];
            outputs.forEach(({ text, className }) => {
                const line = document.createElement('div');
                line.className = `terminal-line ${className}`;
                line.textContent = text;
                terminal.appendChild(line);
            });
            terminal.scrollTop = terminal.scrollHeight;

            updateButtons();
            renderProjectList(document.getElementById('filterInput').value);
        }

        function updateButtons() {
            if (!selectedProject) return;
            const isRunning = runningProjects.has(selectedProject.path);

            document.getElementById('btnRun').disabled = isRunning;
            document.getElementById('btnStop').disabled = !isRunning;
            document.getElementById('btnDeploy').disabled = isRunning;
        }

        function updateProjectStatus(path, running) {
            renderProjectList(document.getElementById('filterInput').value);
        }

        function updateRunningIndicator(running) {
            const indicator = document.getElementById('runningIndicator');
            const list = document.getElementById('runningList');

            if (running.length > 0) {
                indicator.classList.add('visible');
                list.innerHTML = running.map(p => `
                    <div class="running-item">
                        <span class="pulse"></span>
                        <span>${p.name}</span>
                    </div>
                `).join('');
            } else {
                indicator.classList.remove('visible');
            }
        }

        function runProject() {
            if (!selectedProject || !ws) return;
            ws.send(JSON.stringify({
                action: 'run',
                projectPath: selectedProject.path,
                projectName: selectedProject.name,
                command: selectedProject.runCommand
            }));
        }

        function stopProject() {
            if (!selectedProject || !ws) return;
            ws.send(JSON.stringify({
                action: 'stop',
                projectPath: selectedProject.path
            }));
        }

        function deployProject() {
            if (!selectedProject || !ws || !selectedProject.buildCommand) return;
            ws.send(JSON.stringify({
                action: 'deploy',
                projectPath: selectedProject.path,
                projectName: selectedProject.name,
                command: selectedProject.buildCommand
            }));
        }

        function installDeps() {
            if (!selectedProject || !ws) return;
            ws.send(JSON.stringify({
                action: 'install',
                projectPath: selectedProject.path,
                projectName: selectedProject.name
            }));
        }

        function openFolder() {
            if (!selectedProject || !ws) return;
            ws.send(JSON.stringify({
                action: 'open',
                projectPath: selectedProject.path
            }));
        }

        function clearTerminal() {
            if (!selectedProject) return;
            document.getElementById('terminal').innerHTML = '';
            terminalOutputs.set(selectedProject.path, []);
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast visible ${type}`;
            setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000);
        }

        // Filter input
        document.getElementById('filterInput').addEventListener('input', (e) => {
            renderProjectList(e.target.value);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'r' && selectedProject) {
                e.preventDefault();
                runProject();
            }
            if (e.ctrlKey && e.key === 's' && selectedProject) {
                e.preventDefault();
                stopProject();
            }
            if (e.ctrlKey && e.key === 'd' && selectedProject) {
                e.preventDefault();
                deployProject();
            }
        });

        // Start connection
        connect();
    </script>
</body>
</html>
